# モックシステム設計書

> **関連**: [設計書サマリ](00_summary.md) | [評価設計](05_evaluation_design.md) | [技術設計](06_technical_design.md)

---

## 1. 概要

### 1.1 目的

本モックシステムは、PoC期間中の**検証・評価・改善サイクル**を効率的に回すための検証プラットフォームである。
開発チームが以下を効率的に実行できることを目指す：

- AI出力結果の確認・評価
- プロンプトの管理・バージョニング
- ナレッジ・商材データの管理
- コスト・速度のモニタリング
- 改善サイクルの追跡

### 1.2 ユーザー

| ユーザー | 役割 | 主な使用機能 |
|----------|------|-------------|
| **開発者** | プロンプト改善、システム改良 | プロンプト管理、中間結果確認、コスト分析 |
| **評価担当者** | 出力品質の評価 | レビュー機能、評価結果確認 |
| **PM** | 進捗・品質把握 | ダッシュボード、レポート出力 |
| **りそな担当者** | 評価参加、フィードバック | レビュー機能、結果確認 |

### 1.3 スコープ

```
┌─────────────────────────────────────────────────────────────────────┐
│                    モックシステム スコープ                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ✅ 含む                              ❌ 含まない                    │
│  ├─ 検証用UI                          ├─ 本番環境デプロイ           │
│  ├─ プロンプト管理                    ├─ セキュリティ対応          │
│  ├─ ナレッジ/データ管理               ├─ スケーラビリティ          │
│  ├─ 結果確認・評価機能                ├─ 外部システム連携          │
│  ├─ コスト・速度可視化                ├─ 高度なUI/UX              │
│  ├─ バージョン管理・固定              └─ マルチテナント           │
│  └─ 改善提案表示                                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. システム構成

### 2.1 アーキテクチャ全体図

```
┌────────────────────────────────────────────────────────────────────────────────────────┐
│                              モックシステム アーキテクチャ                               │
├────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                        │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐  │
│  │                           Frontend (Streamlit)                                   │  │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │  │
│  │  │ Dashboard │ │ Inference │ │ Data Mgmt │ │  Prompt   │ │  Review   │           │  │
│  │  │   Page    │ │   Page    │ │   Page    │ │   Page    │ │   Page    │           │  │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘           │  │
│  └──────────────────────────────────────────────────────────────────────────────────┘  │
│                                           │                                            │
│                                           ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐  │
│  │                           Backend (FastAPI)                                      │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  │  │
│  │  │ InferenceAPI   │  │ DataAPI        │  │ PromptAPI      │  │ ReviewAPI      │  │  │
│  │  │ (推論実行)     │  │ (データ管理)   │  │ (プロンプト)   │  │ (評価管理)     │  │  │
│  │  └────────────────┘  └────────────────┘  └────────────────┘  └────────────────┘  │  │
│  │                                                                                  │  │
│  │  ┌──────────────────────────────────────────────────────────────────────────┐    │  │
│  │  │                     Core Services                                        │    │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │    │  │
│  │  │  │ NeedsEstim   │  │ SolutionRec  │  │ AutoEval     │  │ CostTracker  │  │    │  │
│  │  │  │ ator         │  │ ommender     │  │ uator        │  │              │  │    │  │
│  │  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │    │  │
│  │  └──────────────────────────────────────────────────────────────────────────┘    │  │
│  └──────────────────────────────────────────────────────────────────────────────────┘  │
│                          │                              │                              │
│              ┌───────────┴───────────┐      ┌──────────┴──────────┐                   │
│              ▼                       ▼      ▼                     ▼                   │
│  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────────────────────┐  │
│  │  Azure OpenAI     │  │  Storage (SQLite  │  │  Tracer (Opik)                    │  │
│  │  (GPT-5.2)        │  │  / PostgreSQL)    │  │  - トレース                       │  │
│  │  - Chat API       │  │  - 実行履歴       │  │  - 評価記録                       │  │
│  │  - Embedding API  │  │  - プロンプト     │  │  - コスト・速度                   │  │
│  │                   │  │  - ナレッジ       │  │                                   │  │
│  └───────────────────┘  └───────────────────┘  └───────────────────────────────────┘  │
│                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 技術スタック

| レイヤー | 技術 | 選定理由 |
|----------|------|----------|
| **Frontend** | Streamlit | 高速プロトタイピング、Python親和性 |
| **Backend** | FastAPI | 非同期処理、型安全、Swagger自動生成 |
| **Database** | SQLite (→PostgreSQL) | PoC段階は軽量SQLite、本番はPostgreSQL |
| **LLM** | Azure OpenAI (GPT-5.2) | 企業向け、セキュリティ |
| **Tracer** | Opik (抽象化レイヤー経由) | 評価追跡、LangFuse移行可能 |
| **ファイルストレージ** | ローカルFS / Azure Blob | PoC段階はローカル |

---

## 3. 機能一覧

### 3.1 機能マップ

```
┌─────────────────────────────────────────────────────────────────────┐
│                       モックシステム 機能マップ                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  📊 ダッシュボード                                                   │
│  ├─ 全体KPIサマリ（通過率、ハルシ率、コスト等）                     │
│  ├─ 日別推移グラフ                                                  │
│  └─ 最新実行結果一覧                                                │
│                                                                     │
│  🤖 推論実行                                                         │
│  ├─ 単発実行（1ケース）                                             │
│  ├─ バッチ実行（複数ケース）                                        │
│  ├─ 中間結果リアルタイム表示                                        │
│  └─ 対話的ブラッシュアップ                                          │
│                                                                     │
│  📁 データ管理                                                       │
│  ├─ ナレッジ管理（追加・編集・削除）                                │
│  ├─ 商材マスタ管理                                                  │
│  ├─ テストケース管理（100シナリオ）                                 │
│  └─ ドキュメント管理                                                │
│                                                                     │
│  📝 プロンプト管理                                                   │
│  ├─ プロンプト一覧・編集                                            │
│  ├─ バージョン管理（差分表示）                                      │
│  ├─ バージョン固定・タグ付け                                        │
│  └─ A/Bテスト設定                                                   │
│                                                                     │
│  📈 結果・評価                                                       │
│  ├─ 実行結果一覧（検索・フィルタ）                                  │
│  ├─ 詳細表示（入力・出力・中間結果）                                │
│  ├─ 自動評価結果（Layer1）                                          │
│  ├─ 人手評価登録（Layer3）                                          │
│  └─ 結果ダウンロード（CSV/JSON）                                    │
│                                                                     │
│  💰 コスト・パフォーマンス                                           │
│  ├─ プロセス別コスト表示                                            │
│  ├─ トークン使用量                                                  │
│  ├─ 処理時間（レイテンシ）                                          │
│  └─ コスト推移グラフ                                                │
│                                                                     │
│  🔧 改善提案                                                         │
│  ├─ 低評価ケース分析                                                │
│  ├─ 改善提案表示（自動生成）                                        │
│  └─ 改善履歴                                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 機能詳細

#### 3.2.1 ダッシュボード

| 機能 | 説明 | 優先度 |
|------|------|:------:|
| **KPIサマリ** | Layer1通過率、ハルシ率、平均コスト等を表示 | 高 |
| **推移グラフ** | 日別/プロンプトバージョン別のKPI推移 | 中 |
| **最新結果** | 直近N件の実行結果をクイック表示 | 高 |
| **アラート** | 異常値（ハルシ率急上昇等）をハイライト | 低 |

#### 3.2.2 推論実行

| 機能 | 説明 | 優先度 |
|------|------|:------:|
| **単発実行** | 1ケースを指定して推論を実行 | 高 |
| **バッチ実行** | 複数ケース（最大100件）を一括実行 | 高 |
| **中間結果表示** | AI①→AI②の各ステップの出力を確認 | 高 |
| **対話ブラッシュアップ** | ユーザーのフィードバックで出力を改善 | 中 |
| **バージョン指定実行** | 特定のプロンプトバージョンで実行 | 高 |

#### 3.2.3 データ管理

| 機能 | 説明 | 優先度 |
|------|------|:------:|
| **ナレッジ管理** | 過去事例・知見をアップロード・編集 | 高 |
| **商材マスタ** | 商品/サービス情報の追加・編集 | 高 |
| **テストケース** | 検証用100シナリオの管理 | 高 |
| **ドキュメント** | 補助資料のアップロード・参照 | 中 |
| **インポート/エクスポート** | CSV/JSON形式での一括操作 | 中 |

#### 3.2.4 プロンプト管理

| 機能 | 説明 | 優先度 |
|------|------|:------:|
| **プロンプト一覧** | 全LLMプロンプトの一覧表示 | 高 |
| **バージョン管理** | 変更履歴・差分表示（Git風） | 高 |
| **タグ付け** | 「baseline」「best_v2」等のラベル | 高 |
| **バージョン固定** | 特定バージョンを「固定」して再評価用に保持 | 高 |
| **A/Bテスト** | 2つのバージョンを比較実行 | 中 |

#### 3.2.5 結果・評価

| 機能 | 説明 | 優先度 |
|------|------|:------:|
| **結果一覧** | 全実行結果を検索・フィルタ | 高 |
| **詳細表示** | 入力→中間→出力の全データ表示 | 高 |
| **自動評価** | Layer1結果（ハルシ、矛盾等）の表示 | 高 |
| **人手評価登録** | Layer3評価（◯/△/×、コメント）の入力 | 高 |
| **一括ダウンロード** | CSV/JSON/Excelでエクスポート | 高 |
| **比較表示** | 2つの結果を並べて比較 | 中 |

#### 3.2.6 コスト・パフォーマンス

| 機能 | 説明 | 優先度 |
|------|------|:------:|
| **プロセス別コスト** | AI①/AI②/評価それぞれのコスト | 高 |
| **トークン詳細** | input/output別のトークン数 | 高 |
| **レイテンシ** | 各プロセスの処理時間 | 高 |
| **推移グラフ** | コスト・速度の時系列変化 | 中 |
| **予算アラート** | 設定した予算を超えた場合に警告 | 低 |

#### 3.2.7 改善提案

| 機能 | 説明 | 優先度 |
|------|------|:------:|
| **低評価分析** | ×判定が多いケースのパターン分析 | 中 |
| **自動改善提案** | LLMによる改善提案の自動生成 | 中 |
| **改善履歴** | 過去の改善とその効果の追跡 | 低 |

---

## 4. 画面設計

### 4.1 画面一覧

| # | 画面名 | パス | 説明 |
|---|--------|------|------|
| 1 | ダッシュボード | `/` | トップ、KPIサマリ |
| 2 | 推論実行 | `/inference` | 単発・バッチ実行 |
| 3 | 結果一覧 | `/results` | 実行結果の検索・一覧 |
| 4 | 結果詳細 | `/results/{id}` | 1件の詳細表示 |
| 5 | データ管理 | `/data` | ナレッジ・商材・ケース |
| 6 | プロンプト管理 | `/prompts` | プロンプト一覧・編集 |
| 7 | プロンプト詳細 | `/prompts/{id}` | バージョン履歴・編集 |
| 8 | レビュー | `/review` | 人手評価の入力 |
| 9 | コスト分析 | `/cost` | コスト・速度の可視化 |
| 10 | 改善提案 | `/improvements` | 改善提案の表示 |

### 4.2 画面詳細設計

#### 4.2.1 ダッシュボード (`/`)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  🏠 ダッシュボード                                          [日付範囲選択 ▼]   │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │ Layer1通過率 │ │ ハルシ率    │ │ 平均コスト  │ │ 実行件数    │              │
│  │   92.3%     │ │   3.2%     │ │  ¥42/件    │ │   156件     │              │
│  │   ↑ 1.2%   │ │   ↓ 0.5%  │ │   → 0%    │ │   ↑ 23件   │              │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘              │
│                                                                                │
│  ┌──────────────────────────────────┐  ┌─────────────────────────────────────┐│
│  │      📈 KPI推移グラフ            │  │      📋 最新実行結果                ││
│  │                                  │  │                                     ││
│  │  [Layer1通過率の日別推移]         │  │  ID    | 日時      | 評価 | コスト  ││
│  │                                  │  │  #156  | 01/22 14:30| ◯   | ¥45    ││
│  │  100% ─────────────────────────  │  │  #155  | 01/22 14:15| △   | ¥38    ││
│  │   90% ─────・─────・─────────    │  │  #154  | 01/22 13:45| ◯   | ¥42    ││
│  │   80% ─────────────────────────  │  │  #153  | 01/22 13:30| ×   | ¥51    ││
│  │        1/18  1/19  1/20  1/21    │  │  #152  | 01/22 13:00| ◯   | ¥39    ││
│  │                                  │  │                                     ││
│  │  [Tab: 通過率 | ハルシ率 | コスト]│  │                [もっと見る →]       ││
│  └──────────────────────────────────┘  └─────────────────────────────────────┘│
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  ⚠️ アラート                                                            │  │
│  │  • 01/22: プロンプトv3.2でハルシ率が5.1%に上昇（閾値5%超過）            │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.2 推論実行 (`/inference`)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  🤖 推論実行                                                                   │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  [Tab: 単発実行 | バッチ実行 | 対話ブラッシュアップ]                           │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📋 入力設定                                                            │  │
│  │                                                                          │  │
│  │  テストケース:   [ケース選択 ▼] または [カスタム入力]                   │  │
│  │                                                                          │  │
│  │  プロンプトver:  [v3.2 (latest) ▼]  □ バージョン固定                   │  │
│  │  ナレッジ:       [デフォルト ▼]     [+ カスタム追加]                    │  │
│  │                                                                          │  │
│  │  ────────────────────────────────────────────────────────────────────── │  │
│  │  企業情報:                                                               │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│  │  │ 株式会社サンプル商事                                               │ │  │
│  │  │ 業種: 卸売業 / 年商: 50億円 / 従業員: 120名                        │ │  │
│  │  │ ...                                                                │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                          │  │
│  │  面談記録:                                                               │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│  │  │ 2025/01/15 訪問メモ                                                │ │  │
│  │  │ 社長より海外展開に関心があるとの話あり...                          │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                          │  │
│  │                                    [実行 🚀]                             │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📤 実行結果                                                 [展開/折畳]│  │
│  │                                                                          │  │
│  │  ステータス: ✅ 完了 (3.2秒)                                            │  │
│  │                                                                          │  │
│  │  ┌── Step 1: ニーズ推定 (AI①) ────────────────────────────────────────┐ │  │
│  │  │  処理時間: 1.8秒 | トークン: 1,245 | コスト: ¥18                    │ │  │
│  │  │                                                                    │ │  │
│  │  │  【推定ニーズ】                                                    │ │  │
│  │  │  1. 海外展開支援 (優先度: 高)                                      │ │  │
│  │  │     根拠: 社長が海外展開に関心、アジア市場開拓の意向              │ │  │
│  │  │  2. 資金調達 (優先度: 中)                                          │ │  │
│  │  │     根拠: 設備投資計画あり、現状の借入余力から追加融資が必要      │ │  │
│  │  │  ...                                                               │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  │                              ↓                                          │  │
│  │  ┌── Step 2: ソリューション推薦 (AI②) ───────────────────────────────┐ │  │
│  │  │  処理時間: 1.4秒 | トークン: 1,890 | コスト: ¥24                    │ │  │
│  │  │                                                                    │ │  │
│  │  │  【提案方針】                                                      │ │  │
│  │  │  海外展開ニーズに対し、まず貿易金融サービスを軸に提案...          │ │  │
│  │  │                                                                    │ │  │
│  │  │  【推薦商材】                                                      │ │  │
│  │  │  1. 海外送金サービス / 2. 貿易保険 / 3. 設備投資融資             │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  │                              ↓                                          │  │
│  │  ┌── Step 3: 自動評価 (Layer1) ──────────────────────────────────────┐ │  │
│  │  │  ハルシネーション: ✅ Pass  | 論理整合性: ✅ Pass                  │ │  │
│  │  │  ニーズ網羅性: 4/5 (◯)    | 根拠妥当性: 4/5 (◯)                  │ │  │
│  │  │  総合評価: ◯                                                       │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                          │  │
│  │  [詳細を見る] [結果をダウンロード ↓] [人手評価へ →]                     │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.3 プロンプト管理 (`/prompts`)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  📝 プロンプト管理                                                             │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  プロンプト一覧                                        [+ 新規作成]      │  │
│  │                                                                          │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│  │  │ 名前                    │ 用途        │ 最新ver │ 固定ver │ 更新日  │ │  │
│  │  │─────────────────────────┼─────────────┼─────────┼─────────┼─────────│ │  │
│  │  │ needs_estimation_system │ AI① システム│ v3.2    │ v3.0🔒  │ 01/22   │ │  │
│  │  │ needs_estimation_user   │ AI① ユーザー│ v2.8    │ -       │ 01/21   │ │  │
│  │  │ solution_system         │ AI② システム│ v2.5    │ v2.3🔒  │ 01/20   │ │  │
│  │  │ solution_user           │ AI② ユーザー│ v2.1    │ -       │ 01/19   │ │  │
│  │  │ evaluation_judge        │ 評価用      │ v1.3    │ v1.0🔒  │ 01/18   │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📄 プロンプト詳細: needs_estimation_system                              │  │
│  │                                                                          │  │
│  │  バージョン履歴:                                                         │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│  │  │ ver   │ 日時            │ 変更者   │ タグ     │ 操作              │ │  │
│  │  │───────┼─────────────────┼──────────┼──────────┼───────────────────│ │  │
│  │  │ v3.2  │ 01/22 14:00     │ 田中     │ latest   │ [表示] [固定]     │ │  │
│  │  │ v3.1  │ 01/21 10:30     │ 田中     │          │ [表示] [固定]     │ │  │
│  │  │ v3.0  │ 01/20 09:00     │ 鈴木     │ 🔒固定    │ [表示] [解除]     │ │  │
│  │  │ v2.9  │ 01/19 15:00     │ 田中     │          │ [表示] [固定]     │ │  │
│  │  │ ...                                                                │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                          │  │
│  │  ┌── 差分表示: v3.1 → v3.2 ─────────────────────────────────────────┐   │  │
│  │  │ @@ -15,7 +15,9 @@                                                │   │  │
│  │  │  あなたは顧客ニーズ推定の専門家です。                           │   │  │
│  │  │  以下の情報を分析し、潜在的なニーズを推定してください。         │   │  │
│  │  │                                                                  │   │  │
│  │  │ -推定にあたっては、過去の類似事例を参考にしてください。         │   │  │
│  │  │ +推定にあたっては、以下の観点を重視してください：               │   │  │
│  │  │ +1. 過去の類似事例との比較                                      │   │  │
│  │  │ +2. 業界特有のニーズパターン                                    │   │  │
│  │  │ +3. 企業のライフステージ                                        │   │  │
│  │  └──────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                          │  │
│  │  [編集] [A/Bテスト設定] [バージョン間比較]                               │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.4 データ管理 (`/data`)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  📁 データ管理                                                                 │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  [Tab: ナレッジ | 商材マスタ | テストケース | ドキュメント]                    │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📚 ナレッジ管理                      [+ 追加] [⬆️ インポート] [⬇️ 出力] │  │
│  │                                                                          │  │
│  │  検索: [                          🔍]  フィルタ: [カテゴリ ▼]           │  │
│  │                                                                          │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│  │  │ ID    │ タイトル                  │ カテゴリ   │ 更新日   │ 操作   │ │  │
│  │  │───────┼───────────────────────────┼────────────┼──────────┼────────│ │  │
│  │  │ K001  │ 製造業の事業承継パターン  │ 事業承継   │ 01/20    │ [編集] │ │  │
│  │  │ K002  │ 卸売業の資金調達事例     │ 資金調達   │ 01/19    │ [編集] │ │  │
│  │  │ K003  │ 海外展開時の注意点       │ 海外展開   │ 01/18    │ [編集] │ │  │
│  │  │ K004  │ M&A成約事例（中小企業）   │ M&A       │ 01/17    │ [編集] │ │  │
│  │  │ ...                                                                │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                          │  │
│  │  ─────────────────────────────────────────────────────────────────────── │  │
│  │                                                                          │  │
│  │  📝 ナレッジ編集: K001                                                   │  │
│  │                                                                          │  │
│  │  タイトル:  [製造業の事業承継パターン                        ]          │  │
│  │  カテゴリ:  [事業承継 ▼]                                                │  │
│  │  タグ:      [製造業] [中小企業] [+追加]                                 │  │
│  │                                                                          │  │
│  │  内容:                                                                   │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│  │  │ ## 概要                                                            │ │  │
│  │  │ 製造業における事業承継では、以下のパターンが多い:                  │ │  │
│  │  │                                                                    │ │  │
│  │  │ 1. 親族内承継（60%）                                               │ │  │
│  │  │    - 子息への承継が最も多い                                        │ │  │
│  │  │    - 準備期間：平均5-7年                                           │ │  │
│  │  │ ...                                                                │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                          │  │
│  │                                      [キャンセル] [保存]                 │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.5 レビュー（人手評価） (`/review`)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  📋 レビュー（人手評価）                                                       │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  評価対象選択                         ステータス: 15/50件 評価完了       │  │
│  │                                                                          │  │
│  │  表示:  [○ 未評価のみ | すべて]     並び順: [自動評価スコア ▼]         │  │
│  │                                                                          │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│  │  │ ID    │ 企業名        │ 自動評価 │ 人手評価 │ 評価者   │ 操作     │ │  │
│  │  │───────┼───────────────┼──────────┼──────────┼──────────┼──────────│ │  │
│  │  │ #153  │ ○○商事       │ △ (3.2) │ -        │ -        │ [評価→] │ │  │
│  │  │ #148  │ △△工業       │ × (2.1) │ -        │ -        │ [評価→] │ │  │
│  │  │ #145  │ □□サービス   │ ◯ (4.5) │ ◯        │ 田中     │ [確認]  │ │  │
│  │  │ ...                                                                │ │  │
│  │  └────────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📝 評価入力: #153 ○○商事                                               │  │
│  │                                                                          │  │
│  │  ┌──────────────────────┐  ┌──────────────────────────────────────────┐ │  │
│  │  │ 【入力情報】         │  │ 【AI出力】                               │ │  │
│  │  │                      │  │                                          │ │  │
│  │  │ 企業: ○○商事        │  │ 【推定ニーズ】                           │ │  │
│  │  │ 業種: 卸売業         │  │ 1. 海外展開支援（高）                    │ │  │
│  │  │ 年商: 50億円         │  │ 2. 資金調達（中）                        │ │  │
│  │  │                      │  │ 3. 事業承継（中）                        │ │  │
│  │  │ 【面談記録】         │  │                                          │ │  │
│  │  │ 社長より海外展開に   │  │ 【提案方針】                             │ │  │
│  │  │ 関心があるとの話...  │  │ 海外展開ニーズに対し、貿易金融を軸に... │ │  │
│  │  │                      │  │                                          │ │  │
│  │  │ [全文表示]           │  │ [全文表示]                               │ │  │
│  │  └──────────────────────┘  └──────────────────────────────────────────┘ │  │
│  │                                                                          │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │  │ 【評価入力】                                                     │   │  │
│  │  │                                                                  │   │  │
│  │  │ 総合評価:  (◯) そのまま使える  (△) 参考になる  (×) 使えない   │   │  │
│  │  │                                                                  │   │  │
│  │  │ 観点別評価:                                                      │   │  │
│  │  │ ├─ ニーズ網羅性:    [◯ ▼]   コメント: [                    ]   │   │  │
│  │  │ ├─ 根拠の妥当性:    [△ ▼]   コメント: [証跡が弱い部分あり  ]   │   │  │
│  │  │ ├─ 実用性:          [◯ ▼]   コメント: [                    ]   │   │  │
│  │  │ └─ 提案の適切さ:    [◯ ▼]   コメント: [                    ]   │   │  │
│  │  │                                                                  │   │  │
│  │  │ 総合コメント:                                                    │   │  │
│  │  │ ┌────────────────────────────────────────────────────────────┐   │   │  │
│  │  │ │ 海外展開のニーズは的確に捉えている。ただし、事業承継に     │   │   │  │
│  │  │ │ ついては社長の年齢からもう少し優先度を上げても良い。       │   │   │  │
│  │  │ └────────────────────────────────────────────────────────────┘   │   │  │
│  │  │                                                                  │   │  │
│  │  │                         [スキップ] [前へ] [保存して次へ →]       │   │  │
│  │  └──────────────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.6 コスト・パフォーマンス分析 (`/cost`)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  💰 コスト・パフォーマンス分析                            [期間: 過去7日 ▼]   │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │ 総コスト    │ │ 平均コスト  │ │ 平均レイテンシ│ │ 総トークン  │              │
│  │  ¥6,552    │ │  ¥42/件    │ │   3.2秒     │ │  2.1M      │              │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘              │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📊 プロセス別内訳                                                      │  │
│  │                                                                          │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │  │ プロセス           │ 平均コスト │ 平均時間 │ 平均トークン │ 割合  │   │  │
│  │  │────────────────────┼────────────┼──────────┼──────────────┼───────│   │  │
│  │  │ AI① ニーズ推定    │ ¥18       │ 1.8秒    │ 1,250       │ 43%   │   │  │
│  │  │ AI② ソリューション │ ¥24       │ 1.4秒    │ 1,900       │ 57%   │   │  │
│  │  │ 自動評価 (Layer1)  │ ¥8        │ 0.8秒    │ 650         │ -     │   │  │
│  │  │────────────────────┼────────────┼──────────┼──────────────┼───────│   │  │
│  │  │ 合計               │ ¥50       │ 4.0秒    │ 3,800       │ 100%  │   │  │
│  │  └──────────────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📈 コスト推移                                                          │  │
│  │                                                                          │  │
│  │  ¥60 ─                                                                   │  │
│  │  ¥50 ─    ・─・─・───・                                                  │  │
│  │  ¥40 ─ ・─            ─・─・                                            │  │
│  │  ¥30 ─                                                                   │  │
│  │       ──────────────────────────────────────                             │  │
│  │       1/16  1/17  1/18  1/19  1/20  1/21  1/22                           │  │
│  │                                                                          │  │
│  │  [凡例: ─── 平均コスト  ─・─ プロンプト変更]                           │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  ⚙️ プロンプトバージョン別分析                                          │  │
│  │                                                                          │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │  │ バージョン │ 平均コスト │ 平均精度  │ コスパ      │ 実行数       │   │  │
│  │  │────────────┼────────────┼───────────┼─────────────┼──────────────│   │  │
│  │  │ v3.2       │ ¥45       │ 4.2/5     │ 0.093      │ 35件         │   │  │
│  │  │ v3.1       │ ¥42       │ 4.0/5     │ 0.095      │ 48件         │   │  │
│  │  │ v3.0 🔒    │ ¥38       │ 3.8/5     │ 0.100 ⭐    │ 73件         │   │  │
│  │  └──────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                          │  │
│  │  ※コスパ = 精度 / コスト（高いほど効率的）                               │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.7 改善提案 (`/improvements`)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  🔧 改善提案                                                                   │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📊 低評価ケース分析                                                    │  │
│  │                                                                          │  │
│  │  直近7日間の×判定: 8件 / 156件 (5.1%)                                   │  │
│  │                                                                          │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │  │ 失敗パターン分類                                                 │   │  │
│  │  │                                                                  │   │  │
│  │  │  ■■■■■■■■■■ ハルシネーション (38%)                              │   │  │
│  │  │  ■■■■■■■    論理矛盾 (25%)                                       │   │  │
│  │  │  ■■■■■      ニーズ漏れ (25%)                                     │   │  │
│  │  │  ■■         その他 (12%)                                         │   │  │
│  │  └──────────────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  💡 自動生成された改善提案                               [再生成 🔄]     │  │
│  │                                                                          │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │  │ 📌 提案 #1: ハルシネーション対策（優先度: 高）                   │   │  │
│  │  │                                                                  │   │  │
│  │  │ 【問題】                                                         │   │  │
│  │  │ 商材名「ビジネスローンプレミアム」等、存在しない商品名を出力    │   │  │
│  │  │ している（3件）                                                  │   │  │
│  │  │                                                                  │   │  │
│  │  │ 【改善案】                                                       │   │  │
│  │  │ システムプロンプトに以下を追加:                                  │   │  │
│  │  │ 「推薦する商材は、必ず提供された商材マスタに存在するものに      │   │  │
│  │  │  限定してください。マスタにない商品名を出力しないでください。」 │   │  │
│  │  │                                                                  │   │  │
│  │  │ 【期待効果】                                                     │   │  │
│  │  │ ハルシネーション率: 5.1% → 2%以下                               │   │  │
│  │  │                                                                  │   │  │
│  │  │ [適用してテスト] [詳細を見る] [却下]                             │   │  │
│  │  └──────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                          │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │  │ 📌 提案 #2: 事業承継ニーズの検出強化（優先度: 中）               │   │  │
│  │  │                                                                  │   │  │
│  │  │ 【問題】                                                         │   │  │
│  │  │ 社長の年齢が60歳以上のケースで事業承継ニーズを見落としている    │   │  │
│  │  │ （2件）                                                          │   │  │
│  │  │                                                                  │   │  │
│  │  │ 【改善案】                                                       │   │  │
│  │  │ プロンプトに明示的なルールを追加:                                │   │  │
│  │  │ 「社長/代表者の年齢が60歳以上の場合、事業承継ニーズを必ず       │   │  │
│  │  │  検討項目に含めてください。」                                    │   │  │
│  │  │                                                                  │   │  │
│  │  │ [適用してテスト] [詳細を見る] [却下]                             │   │  │
│  │  └──────────────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  📜 改善履歴                                                            │  │
│  │                                                                          │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │  │ 日付     │ 改善内容                    │ 効果              │ 状態 │   │  │
│  │  │──────────┼─────────────────────────────┼───────────────────┼──────│   │  │
│  │  │ 01/21    │ Few-shot例追加（海外展開）  │ 精度 +8%          │ ✅   │   │  │
│  │  │ 01/20    │ 商材マスタ参照の明示化      │ ハルシ率 -2.1%    │ ✅   │   │  │
│  │  │ 01/18    │ 出力フォーマット統一        │ 処理時間 -0.5秒   │ ✅   │   │  │
│  │  └──────────────────────────────────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. データモデル

### 5.1 ER図

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                              データモデル ER図                                 │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ┌──────────────────┐         ┌──────────────────┐                            │
│  │ Prompt           │         │ PromptVersion    │                            │
│  │──────────────────│ 1     * │──────────────────│                            │
│  │ id               ├─────────┤ id               │                            │
│  │ name             │         │ prompt_id        │                            │
│  │ purpose          │         │ version          │                            │
│  │ created_at       │         │ content          │                            │
│  └──────────────────┘         │ is_locked        │                            │
│                               │ tag              │                            │
│                               │ created_at       │                            │
│                               │ created_by       │                            │
│                               └──────────────────┘                            │
│                                       │                                        │
│                                       │ *                                      │
│  ┌──────────────────┐         ┌──────┴───────────┐         ┌────────────────┐ │
│  │ TestCase         │ 1     * │ ExecutionResult  │ 1     1 │ Review         │ │
│  │──────────────────├─────────┤──────────────────├─────────┤────────────────│ │
│  │ id               │         │ id               │         │ id             │ │
│  │ company_info     │         │ test_case_id     │         │ result_id      │ │
│  │ hearing_info     │         │ prompt_version_id│         │ overall_rating │ │
│  │ expected_needs   │         │ input_data       │         │ ratings (json) │ │
│  │ metadata         │         │ output_data      │         │ comment        │ │
│  └──────────────────┘         │ intermediate     │         │ reviewer       │ │
│                               │ auto_evaluation  │         │ created_at     │ │
│  ┌──────────────────┐         │ cost_info        │         └────────────────┘ │
│  │ Knowledge        │         │ latency_info     │                            │
│  │──────────────────│         │ status           │                            │
│  │ id               │         │ created_at       │                            │
│  │ title            │         └──────────────────┘                            │
│  │ category         │                                                         │
│  │ content          │         ┌──────────────────┐                            │
│  │ tags (json)      │         │ Product          │                            │
│  │ created_at       │         │──────────────────│                            │
│  │ updated_at       │         │ id               │                            │
│  └──────────────────┘         │ name             │                            │
│                               │ category         │                            │
│                               │ description      │                            │
│                               │ use_cases        │                            │
│                               │ metadata         │                            │
│                               └──────────────────┘                            │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 テーブル定義

#### 5.2.1 Prompt（プロンプト）

| カラム名 | 型 | 説明 |
|----------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(100) | プロンプト名（一意） |
| purpose | VARCHAR(50) | 用途（needs_system, solution_user等） |
| description | TEXT | 説明 |
| created_at | TIMESTAMP | 作成日時 |

#### 5.2.2 PromptVersion（プロンプトバージョン）

| カラム名 | 型 | 説明 |
|----------|-----|------|
| id | UUID | 主キー |
| prompt_id | UUID | FK → Prompt |
| version | VARCHAR(20) | バージョン番号（v1.0, v1.1等） |
| content | TEXT | プロンプト本文 |
| is_locked | BOOLEAN | 固定フラグ |
| tag | VARCHAR(50) | タグ（latest, baseline等） |
| created_at | TIMESTAMP | 作成日時 |
| created_by | VARCHAR(100) | 作成者 |

#### 5.2.3 ExecutionResult（実行結果）

| カラム名 | 型 | 説明 |
|----------|-----|------|
| id | UUID | 主キー |
| test_case_id | UUID | FK → TestCase（NULL可＝カスタム入力） |
| prompt_versions | JSON | 使用したプロンプトバージョン群 |
| input_data | JSON | 入力データ全体 |
| output_data | JSON | 最終出力 |
| intermediate_results | JSON | 中間結果（AI①出力等） |
| auto_evaluation | JSON | Layer1自動評価結果 |
| cost_info | JSON | コスト情報 |
| latency_info | JSON | レイテンシ情報 |
| status | VARCHAR(20) | ステータス（success, failed, pending） |
| trace_id | VARCHAR(100) | Opikトレース ID |
| created_at | TIMESTAMP | 実行日時 |

```json
// cost_info の構造例
{
  "total_cost_yen": 45,
  "breakdown": {
    "needs_estimation": { "input_tokens": 800, "output_tokens": 450, "cost_yen": 18 },
    "solution_recommendation": { "input_tokens": 1200, "output_tokens": 700, "cost_yen": 24 },
    "auto_evaluation": { "input_tokens": 500, "output_tokens": 150, "cost_yen": 3 }
  }
}

// latency_info の構造例
{
  "total_seconds": 4.2,
  "breakdown": {
    "needs_estimation": 1.8,
    "solution_recommendation": 1.6,
    "auto_evaluation": 0.8
  }
}

// intermediate_results の構造例
{
  "needs_estimation": {
    "raw_output": "...",
    "parsed": { "needs": [...], "summary": "..." },
    "timestamp": "2025-01-22T14:30:00Z"
  },
  "solution_recommendation": {
    "raw_output": "...",
    "parsed": { "strategy": "...", "products": [...] },
    "timestamp": "2025-01-22T14:30:02Z"
  }
}
```

#### 5.2.4 Review（人手評価）

| カラム名 | 型 | 説明 |
|----------|-----|------|
| id | UUID | 主キー |
| result_id | UUID | FK → ExecutionResult |
| overall_rating | VARCHAR(10) | 総合評価（◯/△/×） |
| ratings | JSON | 観点別評価 |
| comment | TEXT | コメント |
| reviewer | VARCHAR(100) | 評価者 |
| created_at | TIMESTAMP | 評価日時 |

```json
// ratings の構造例
{
  "needs_coverage": { "rating": "◯", "comment": "" },
  "evidence_quality": { "rating": "△", "comment": "証跡が弱い部分あり" },
  "practicality": { "rating": "◯", "comment": "" },
  "solution_fit": { "rating": "◯", "comment": "" }
}
```

#### 5.2.5 Knowledge（ナレッジ）

| カラム名 | 型 | 説明 |
|----------|-----|------|
| id | UUID | 主キー |
| title | VARCHAR(200) | タイトル |
| category | VARCHAR(50) | カテゴリ |
| content | TEXT | 内容（Markdown可） |
| tags | JSON | タグ配列 |
| is_active | BOOLEAN | 有効フラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.6 Product（商材マスタ）

| カラム名 | 型 | 説明 |
|----------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(200) | 商品名 |
| category | VARCHAR(50) | カテゴリ |
| description | TEXT | 説明 |
| use_cases | JSON | 適用ユースケース |
| target_needs | JSON | 対象ニーズ |
| metadata | JSON | その他メタ情報 |
| is_active | BOOLEAN | 有効フラグ |

#### 5.2.7 TestCase（テストケース）

| カラム名 | 型 | 説明 |
|----------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(200) | ケース名 |
| company_info | JSON | 企業情報 |
| hearing_info | TEXT | ヒアリング情報 |
| expected_needs | JSON | 期待されるニーズ（正解データ） |
| expected_solutions | JSON | 期待されるソリューション |
| difficulty | VARCHAR(20) | 難易度（easy/medium/hard） |
| tags | JSON | タグ |
| is_active | BOOLEAN | 有効フラグ |

---

## 6. API設計

### 6.1 API一覧

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| **推論** | | |
| `/api/inference/run` | POST | 単発推論実行 |
| `/api/inference/batch` | POST | バッチ推論実行 |
| `/api/inference/{id}/status` | GET | 実行ステータス確認 |
| **結果** | | |
| `/api/results` | GET | 結果一覧取得 |
| `/api/results/{id}` | GET | 結果詳細取得 |
| `/api/results/export` | POST | 結果エクスポート |
| **プロンプト** | | |
| `/api/prompts` | GET | プロンプト一覧 |
| `/api/prompts/{id}` | GET | プロンプト詳細 |
| `/api/prompts/{id}/versions` | GET | バージョン一覧 |
| `/api/prompts/{id}/versions` | POST | 新バージョン作成 |
| `/api/prompts/{id}/versions/{ver}/lock` | POST | バージョン固定 |
| **データ** | | |
| `/api/knowledge` | GET/POST | ナレッジ一覧/作成 |
| `/api/knowledge/{id}` | GET/PUT/DELETE | ナレッジ詳細 |
| `/api/products` | GET/POST | 商材一覧/作成 |
| `/api/testcases` | GET/POST | テストケース一覧/作成 |
| **レビュー** | | |
| `/api/reviews` | GET/POST | レビュー一覧/作成 |
| `/api/reviews/{id}` | GET/PUT | レビュー詳細/更新 |
| **分析** | | |
| `/api/analytics/dashboard` | GET | ダッシュボードデータ |
| `/api/analytics/cost` | GET | コスト分析データ |
| `/api/analytics/improvements` | GET | 改善提案データ |

### 6.2 API詳細

#### 6.2.1 推論実行 API

```yaml
POST /api/inference/run
---
Request:
  content-type: application/json
  body:
    test_case_id: string | null          # テストケースID（カスタム入力時はnull）
    custom_input:                        # カスタム入力（test_case_idがnullの場合）
      company_info: object
      hearing_info: string
    prompt_versions:                     # 使用するプロンプトバージョン（省略時はlatest）
      needs_system: string | null
      needs_user: string | null
      solution_system: string | null
      solution_user: string | null
    knowledge_ids: string[]              # 使用するナレッジID
    options:
      run_evaluation: boolean            # 自動評価を実行するか（デフォルト: true）
      save_intermediate: boolean         # 中間結果を保存するか（デフォルト: true）

Response:
  id: string                             # 実行ID
  status: "success" | "failed" | "pending"
  output:
    needs_estimation:
      needs: Need[]
      summary: string
    solution_recommendation:
      strategy: string
      products: Product[]
      cautions: string[]
  intermediate_results:
    needs_estimation:
      raw_output: string
      parsed: object
      timestamp: string
    solution_recommendation:
      raw_output: string
      parsed: object
      timestamp: string
  auto_evaluation:
    hallucination_check: { passed: boolean, details: string }
    logic_check: { passed: boolean, details: string }
    rubric_scores:
      needs_coverage: { score: number, rating: string, comment: string }
      evidence_quality: { score: number, rating: string, comment: string }
      # ...
    overall_rating: string
  cost_info:
    total_cost_yen: number
    breakdown: object
  latency_info:
    total_seconds: number
    breakdown: object
  trace_id: string
```

#### 6.2.2 結果エクスポート API

```yaml
POST /api/results/export
---
Request:
  content-type: application/json
  body:
    result_ids: string[]                 # エクスポート対象ID（省略時は全件）
    filters:
      date_from: string
      date_to: string
      rating: string[]                   # ["◯", "△", "×"]
      status: string[]
    format: "csv" | "json" | "excel"
    include:
      input: boolean
      output: boolean
      intermediate: boolean
      evaluation: boolean
      cost: boolean

Response:
  content-type: application/octet-stream
  content-disposition: attachment; filename="results_20250122.csv"
```

#### 6.2.3 プロンプトバージョン作成 API

```yaml
POST /api/prompts/{prompt_id}/versions
---
Request:
  content-type: application/json
  body:
    content: string                      # プロンプト本文
    tag: string | null                   # タグ（"latest"は自動付与）
    comment: string                      # 変更コメント

Response:
  id: string
  prompt_id: string
  version: string                        # 自動採番（v1.0, v1.1...）
  content: string
  tag: string
  diff_from_previous: string             # 差分（unified diff形式）
  created_at: string
  created_by: string
```

---

## 7. 非機能要件

### 7.1 パフォーマンス

| 項目 | 要件 |
|------|------|
| 単発推論 | 10秒以内（LLM呼び出し込み） |
| バッチ推論（100件） | 30分以内 |
| 画面表示 | 3秒以内 |
| エクスポート（100件） | 10秒以内 |

### 7.2 同時利用

| 項目 | 要件 |
|------|------|
| 同時アクセス | 5ユーザー程度 |
| バッチ実行 | 1件/時（同時実行なし） |

### 7.3 データ保持

| 項目 | 要件 |
|------|------|
| 実行結果 | 無期限（PoC期間中） |
| プロンプトバージョン | 全履歴保持 |
| ログ | 30日 |

### 7.4 セキュリティ（PoC）

| 項目 | 対応 |
|------|------|
| 認証 | 簡易認証（Basic認証 or 共有パスワード） |
| 通信 | HTTPS |
| データ暗号化 | なし（PoC） |

---

## 8. 開発計画

### 8.1 フェーズ分け

| フェーズ | 期間 | 内容 |
|----------|------|------|
| **Phase 1** | Week 1-2 | 基盤構築（API/DB/基本UI） |
| **Phase 2** | Week 3-4 | 推論実行・結果表示 |
| **Phase 3** | Week 5-6 | プロンプト管理・データ管理 |
| **Phase 4** | Week 7-8 | レビュー・分析・改善提案 |
| **Phase 5** | Week 9 | 統合テスト・改善 |

### 8.2 MVP（Phase 2完了時点）

```
MVP機能:
✅ 単発推論実行
✅ 結果一覧・詳細表示
✅ 中間結果確認
✅ 自動評価（Layer1）
✅ 基本的なプロンプト管理
✅ 結果ダウンロード（CSV）
```

---

## 9. 付録

### 9.1 技術選定の補足

#### Streamlit vs Gradio

| 観点 | Streamlit | Gradio |
|------|-----------|--------|
| カスタマイズ性 | 高い | 中程度 |
| 学習コスト | 低い | 低い |
| 複雑なレイアウト | 対応可 | 制限あり |
| デプロイ | 簡単 | 簡単 |

→ **Streamlit採用**: 複雑な画面レイアウトに対応可能

#### SQLite vs PostgreSQL

| 観点 | SQLite | PostgreSQL |
|------|--------|------------|
| セットアップ | 不要 | 必要 |
| 同時アクセス | 制限あり | 高い |
| JSON操作 | 基本的 | 高機能 |
| 本番移行 | 移行必要 | そのまま |

→ **SQLite採用（PoC）**: 開発速度優先、本番化時にPostgreSQLへ移行

### 9.2 ディレクトリ構成

```
mock_system/
├── app/
│   ├── api/
│   │   ├── __init__.py
│   │   ├── inference.py
│   │   ├── results.py
│   │   ├── prompts.py
│   │   ├── data.py
│   │   ├── reviews.py
│   │   └── analytics.py
│   ├── core/
│   │   ├── __init__.py
│   │   ├── llm_client.py
│   │   ├── tracer.py
│   │   ├── evaluator.py
│   │   └── cost_tracker.py
│   ├── services/
│   │   ├── __init__.py
│   │   ├── needs_estimator.py
│   │   ├── solution_recommender.py
│   │   └── improvement_suggester.py
│   ├── models/
│   │   ├── __init__.py
│   │   ├── prompt.py
│   │   ├── result.py
│   │   ├── review.py
│   │   └── data.py
│   ├── db/
│   │   ├── __init__.py
│   │   ├── database.py
│   │   └── migrations/
│   └── main.py
├── frontend/
│   ├── pages/
│   │   ├── 1_🏠_Dashboard.py
│   │   ├── 2_🤖_Inference.py
│   │   ├── 3_📋_Results.py
│   │   ├── 4_📝_Prompts.py
│   │   ├── 5_📁_Data.py
│   │   ├── 6_📊_Review.py
│   │   ├── 7_💰_Cost.py
│   │   └── 8_🔧_Improvements.py
│   ├── components/
│   │   ├── __init__.py
│   │   ├── charts.py
│   │   ├── tables.py
│   │   └── forms.py
│   └── Home.py
├── data/
│   ├── prompts/
│   ├── knowledge/
│   ├── products/
│   └── testcases/
├── tests/
├── requirements.txt
├── docker-compose.yml
└── README.md
```

---

> **次のステップ**: Phase 1 基盤構築へ
